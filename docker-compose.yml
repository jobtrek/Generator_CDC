services:
    app:
        build:
            context: .
            dockerfile: Dockerfile
        restart: unless-stopped
        depends_on:
            db:
                condition: service_healthy
        ports:
            - "8000:8000"
        env_file:
            - .env
        environment:
            APP_ENV: production
            DB_HOST: db
            OCTANE_SERVER: frankenphp
        volumes:
            - storage_data:/app/storage
            - caddy_data:/data
            - caddy_config:/config
        networks:
            - cdc_network
        tmpfs:
            - /tmp

    db:
        image: postgres:18.1-trixie
        restart: unless-stopped
        environment:
            POSTGRES_DB: ${DB_DATABASE}
            POSTGRES_USER: ${DB_USERNAME}
            POSTGRES_PASSWORD: ${DB_PASSWORD}
        healthcheck:
            test: [ "CMD", "pg_isready", "-d", "${DB_DATABASE}", "-U", "${DB_USERNAME}" ]
            timeout: 5s
            retries: 5
            start_period: 60s
        volumes:
            - db_data:/var/lib/postgresql
        networks:
            - cdc_network

volumes:
    db_data:
    storage_data:
    caddy_data:
    caddy_config:

networks:
    cdc_network:
